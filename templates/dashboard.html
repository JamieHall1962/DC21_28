{% extends "base.html" %}

{% block title %}Dashboard - SPX Calendar Trading{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <h1><i class="fas fa-tachometer-alt me-2"></i>Trading Dashboard</h1>
            <p class="text-muted">SPX Double Calendar Spread Automated Trading System</p>
        </div>
    </div>

    <!-- Clean Header Section -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body p-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <!-- Left: Title + Stats -->
                        <div class="d-flex align-items-center">
                            <h4 class="mb-0 me-4 text-primary">Trading Dashboard</h4>
                            <div class="d-flex align-items-center text-muted">
                                <span class="me-3 small">
                                    <i class="fas fa-chart-pie me-1"></i>
                                    <strong class="active-positions-count">{{ system_status.active_positions }}</strong>/{{ system_status.max_positions }} Positions
                                </span>
                                <span class="me-3 small">
                                    <i class="fas fa-calendar-day me-1"></i>
                                    <strong class="trades-today-count">{{ system_status.trades_today }}</strong> Today
                                </span>
                                <span class="me-3 small">
                                    <i class="fas fa-layer-group me-1"></i>
                                    <strong>{{ system_status.position_size }}</strong> Contracts
                                </span>
                            </div>
                        </div>
                        
                        <!-- Right: Status Only -->
                        <div class="d-flex align-items-center">
                            <small class="text-muted me-3">
                                <i class="fas fa-robot me-1"></i>
                                {{ 'Auto Running' if system_status.scheduler_running else 'Auto Stopped' }}
                            </small>
                            {% if system_status.connected %}
                                <span class="badge bg-success">Connected</span>
                            {% else %}
                                <span class="badge bg-danger">Disconnected</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Control Reminders -->
    {% set manual_trades = trades|selectattr("status", "equalto", "MANUAL_CONTROL")|list %}
    {% if manual_trades %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-warning d-flex align-items-center" role="alert">
                    <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                    <div class="flex-grow-1">
                        <h5 class="mb-2">‚ö†Ô∏è Manual Control Reminder</h5>
                        <p class="mb-2">You have <strong>{{ manual_trades|length }} trade{{ 's' if manual_trades|length != 1 else '' }}</strong> under manual control that need closing data entered:</p>
                        <ul class="mb-3">
                            {% for trade in manual_trades %}
                                <li><strong>{{ trade.trade_id }}</strong> - {{ trade.days_since_entry }} days old</li>
                            {% endfor %}
                        </ul>
                        <a href="{{ url_for('positions') }}" class="btn btn-warning btn-sm">
                            <i class="fas fa-edit me-1"></i>Record Closing Data Now
                        </a>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- GTC Orders Status & Debug -->
    {% if active_trades %}
        {% set missing_gtc_trades = [] %}
        {% for trade in active_trades %}
            {% if trade.status == "ACTIVE" %}
                {% if trade.profit_target_order_id == 0 or trade.profit_target_order_id < 1000 or trade.profit_target_status in ["NONE", "CANCEL_FAILED"] %}
                    {% set _ = missing_gtc_trades.append(trade) %}
                {% endif %}
            {% endif %}
        {% endfor %}
        {% if missing_gtc_trades %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="alert alert-info d-flex align-items-center" role="alert">
                        <i class="fas fa-bullseye fa-2x me-3"></i>
                        <div class="flex-grow-1">
                            <h5 class="mb-2">‚ö†Ô∏è Missing or Invalid Profit Target Orders</h5>
                            <p class="mb-2">Found <strong>{{ missing_gtc_trades|length }} active trade{{ 's' if missing_gtc_trades|length != 1 else '' }}</strong> with missing or invalid GTC profit target orders:</p>
                            <ul class="mb-3">
                                {% for trade in missing_gtc_trades %}
                                    <li>
                                        <strong>{{ trade.trade_id }}</strong> - Entry: ${{ "{:.2f}".format(trade.entry_credit) }} ‚Üí Target: ${{ "{:.1f}".format((trade.entry_credit * 1.5 * 10)|int / 10.0) }}
                                        {% if trade.profit_target_order_id == 0 %}
                                            <span class="badge bg-danger">No Order ID</span>
                                        {% elif trade.profit_target_order_id < 1000 %}
                                            <span class="badge bg-warning text-dark">Invalid ID: {{ trade.profit_target_order_id }}</span>
                                        {% elif trade.profit_target_status in ["NONE", "CANCEL_FAILED"] %}
                                            <span class="badge bg-secondary">{{ trade.profit_target_status }}</span>
                                        {% endif %}
                                    </li>
                                {% endfor %}
                            </ul>
                            <div class="d-flex gap-2">
                                <a href="{{ url_for('place_missing_gtc_orders') }}" class="btn btn-primary btn-sm" 
                                   onclick="return confirm('Place GTC profit target orders for {{ missing_gtc_trades|length }} trade{{ 's' if missing_gtc_trades|length != 1 else '' }}?');">
                                    <i class="fas fa-plus me-1"></i>Place Missing GTC Orders
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% endif %}
    {% endif %}

    <!-- Active Positions -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center py-2">
                    <div class="d-flex align-items-center">
                        <small class="text-muted me-4">Real-time updates</small>
                        <span class="badge bg-info me-3">SPX: <span class="spx-price">{{ system_status.spx_price or 'Loading...' }}</span></span>
                        {% if total_pnl != 0 %}
                            <span class="badge total-pnl-badge {{ 'bg-success' if total_pnl > 0 else 'bg-danger' }} ms-2">
                                Total P&L: ${{ "{:,.0f}".format(total_pnl) }}
                            </span>
                        {% else %}
                            <span class="badge total-pnl-badge ms-2" style="display: none;"></span>
                        {% endif %}
                    </div>
                    <div class="d-flex gap-2">
                        <a href="{{ url_for('positions') }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-list me-1"></i>Positions
                        </a>
                        <a href="{{ url_for('trade_history') }}" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-history me-1"></i>History
                        </a>
                        <a href="{{ url_for('import_trade') }}" class="btn btn-outline-warning btn-sm">
                            <i class="fas fa-file-import me-1"></i>Import
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    {% if active_trades %}
                        {% for trade in active_trades[:7] %}
                            {% set pnl_total = trade.pnl_total if trade.pnl_total else 0 %}
                            {% set pnl_per_contract = trade.pnl_per_contract if trade.pnl_per_contract else 0 %}
                            {% set has_pnl = trade.unrealized_pnl and trade.unrealized_pnl != 0 %}
                            
                            <div class="card mb-1 {{ 'border-success border-2' if trade.unrealized_pnl > 0 else 'border-danger border-2' if trade.unrealized_pnl < 0 else 'border-secondary' }}" data-trade-id="{{ trade.trade_id }}">
                                <div class="card-body py-2 px-3">
                                    <div class="row align-items-center">
                                        <!-- Trade ID -->
                                        <div class="col-1">
                                            <div class="fw-bold text-primary small">{{ trade.trade_id.replace('CAL_', '').replace('_', ' ') }}</div>
                                        </div>
                                        
                                        <!-- Strikes & Expiry -->
                                        <div class="col-2">
                                            <div class="small">{{ trade.put_strike|int }}P / {{ trade.call_strike|int }}C</div>
                                            <div class="text-muted" style="font-size: 0.8rem;">{{ trade.short_expiry_display }} / {{ trade.long_expiry_display }}</div>
                                        </div>
                                        
                                        <!-- Entry Price -->
                                        <div class="col-1 text-center">
                                            <div class="text-muted" style="font-size: 0.75rem;">Entry</div>
                                            <div class="fw-bold small">${{ "%.2f"|format(trade.entry_credit) }}</div>
                                        </div>
                                        
                                        <!-- Current Price -->
                                        <div class="col-1 text-center">
                                            <div class="text-muted" style="font-size: 0.75rem;">Current</div>
                                            <div class="current-price text-info fw-bold small">${{ "%.2f"|format(trade.current_spread_price) }}</div>
                                        </div>
                                        
                                        <!-- Target Price / Exit -->
                                        <div class="col-2 text-center">
                                            <div class="text-muted" style="font-size: 0.75rem;">Target</div>
                                            <div class="fw-bold small">${{ "%.1f"|format(trade.profit_target) }}{% if trade.profit_target_status != "FILLED" %} <span class="text-muted">or {{ trade.exit_date_display }}</span>{% endif %}</div>
                                        </div>
                                        
                                        <!-- GTC Order -->
                                        <div class="col-2 text-center">
                                            {% if trade.profit_target_order_id and trade.profit_target_order_id > 0 %}
                                                <span class="badge bg-info" style="font-size: 0.75rem;" title="GTC Profit Target Order">üéØ {{ trade.profit_target_order_id }}</span>
                                            {% else %}
                                                <span class="text-muted" style="font-size: 0.8rem;">No GTC</span>
                                            {% endif %}
                                        </div>
                                        
                                        <!-- P&L -->
                                        <div class="col-3 text-end">
                                            {% if has_pnl %}
                                                <div class="fw-bold h6 mb-0 pnl-total {{ 'text-success' if trade.unrealized_pnl > 0 else 'text-danger' }}">
                                                    ${{ "{:,.0f}".format(pnl_total) }} <span class="badge {{ 'bg-success' if trade.unrealized_pnl > 0 else 'bg-danger' }} pnl-percent" style="font-size: 0.75rem;">{{ "%.1f"|format((trade.unrealized_pnl / abs(trade.entry_credit)) * 100) }}%</span>
                                                </div>
                                            {% else %}
                                                <div class="fw-bold h6 mb-0 text-muted pnl-total">$0 <span class="badge bg-secondary pnl-percent" style="font-size: 0.75rem;">0%</span></div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                        
                        {% if active_trades|length > 7 %}
                            <div class="text-center">
                                <a href="{{ url_for('positions') }}" class="btn btn-outline-primary">
                                    View {{ active_trades|length - 7 }} More Positions
                                </a>
                            </div>
                        {% endif %}
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <h5>No Active Positions</h5>
                            <p>The system will automatically create positions at 9:45 AM on trading days.</p>
                            <a href="{{ url_for('manual_trade') }}" class="btn btn-primary">Execute Manual Trade</a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- System Info & Recent Activity -->
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Recent Activity</h5>
                    <a href="{{ url_for('view_logs') }}" class="btn btn-outline-secondary btn-sm">View All</a>
                </div>
                <div class="card-body">
                    {% if recent_logs %}
                        {% for log in recent_logs[:8] %}
                            <div class="d-flex align-items-start mb-2">
                                <i class="fas fa-{{ 'check-circle text-success' if log[2] else 'times-circle text-danger' }} me-2 mt-1"></i>
                                <div class="flex-grow-1">
                                    <small class="text-muted">{{ log[3] }}</small>
                                    <div class="small">{{ log[1] }}</div>
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center text-muted">
                            <i class="fas fa-history fa-2x mb-2"></i>
                            <p>No recent activity</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Auto-refresh system status and SPX price every 30 seconds
function updateSystemStatus() {
    fetch('/api/status')
        .then(response => response.json())
        .then(data => {
            // Update SPX price (without $ sign)
            const spxPriceElement = document.querySelector('.spx-price');
            if (spxPriceElement && data.spx_price) {
                spxPriceElement.textContent = data.spx_price.toFixed(2);
            }
            
            // Update connection status
            const connectionBanner = document.querySelector('.connection-banner');
            const connectionStatus = document.querySelector('.connection-status');
            const schedulerStatus = document.querySelector('.scheduler-status');
            
            if (connectionBanner) {
                connectionBanner.className = data.connected ? 
                    'card bg-success text-white connection-banner' : 
                    'card bg-danger text-white connection-banner';
            }
            
            if (connectionStatus) {
                connectionStatus.innerHTML = data.connected ? 
                    '<i class="fas fa-circle text-success me-2"></i><span class="fw-bold">IBKR Connected</span>' :
                    '<i class="fas fa-circle text-danger me-2"></i><span class="fw-bold">IBKR Disconnected</span>';
            }
            
            if (schedulerStatus) {
                schedulerStatus.innerHTML = '<i class="fas fa-robot me-1"></i><small>Scheduler: ' + 
                    (data.scheduler_running ? 'Running' : 'Stopped') + '</small>';
            }
            
            // Update active positions count
            const activePositionsElement = document.querySelector('.active-positions-count');
            if (activePositionsElement) {
                activePositionsElement.textContent = data.active_positions;
            }
            
            // Update trades today count
            const tradesTodayElement = document.querySelector('.trades-today-count');
            if (tradesTodayElement) {
                tradesTodayElement.textContent = data.trades_today;
            }
        })
        .catch(error => {
            console.log('Status update failed:', error);
        });
}

// Update immediately and then every 30 seconds
updateSystemStatus();
setInterval(updateSystemStatus, 30000);

// Auto-refresh P&L data (always-on with streaming data)
let autoRefreshInterval = null;

function updatePnLDisplay() {
    
    fetch('/get_pnl_data')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update each position's P&L display
                data.pnl_data.forEach(trade => {
                    const tradeCard = document.querySelector(`[data-trade-id="${trade.trade_id}"]`);
                    if (tradeCard) {
                        // Update P&L total
                        const pnlTotalElement = tradeCard.querySelector('.pnl-total');
                        if (pnlTotalElement) {
                            pnlTotalElement.textContent = `$${trade.pnl_total.toLocaleString('en-US', {maximumFractionDigits: 0})}`;
                            pnlTotalElement.className = `pnl-total ${trade.unrealized_pnl > 0 ? 'profit-positive' : 'profit-negative'}`;
                        }
                        
                        // Update P&L per contract
                        const pnlPerContractElement = tradeCard.querySelector('.pnl-per-contract');
                        if (pnlPerContractElement) {
                            pnlPerContractElement.textContent = `$${trade.pnl_per_contract.toLocaleString('en-US', {maximumFractionDigits: 0})} per contract`;
                        }
                        
                        // Update percentage
                        const pnlPercentElement = tradeCard.querySelector('.pnl-percent');
                        if (pnlPercentElement) {
                            pnlPercentElement.textContent = `${trade.pnl_percentage.toFixed(1)}%`;
                            pnlPercentElement.className = `pnl-percent ${trade.unrealized_pnl > 0 ? 'text-success' : 'text-danger'}`;
                        }
                        
                        // Update current price
                        const currentPriceElement = tradeCard.querySelector('.current-price');
                        if (currentPriceElement && trade.current_spread_price > 0) {
                            currentPriceElement.textContent = `$${trade.current_spread_price.toFixed(2)}`;
                        }
                    }
                });
                
                // Update last refresh time and streaming status
                const refreshTimeElement = document.querySelector('.pnl-refresh-time');
                if (refreshTimeElement) {
                    const streamingText = data.streaming_active ? ' (LIVE)' : ' (DB)';
                    refreshTimeElement.textContent = `Last updated: ${data.timestamp}${streamingText}`;
                }
                
                // Calculate and update total P&L in real-time
                let totalPnl = 0;
                data.pnl_data.forEach(trade => {
                    if (trade.pnl_total) {
                        totalPnl += trade.pnl_total;
                    }
                });
                
                // Update total P&L badge
                const totalPnlBadge = document.querySelector('.total-pnl-badge');
                if (totalPnlBadge && Math.abs(totalPnl) > 0) {
                    totalPnlBadge.textContent = `Total P&L: $${totalPnl.toLocaleString('en-US', {maximumFractionDigits: 0})}`;
                    totalPnlBadge.className = `badge total-pnl-badge ms-2 ${totalPnl > 0 ? 'bg-success' : 'bg-danger'}`;
                    totalPnlBadge.style.display = 'inline';
                } else if (totalPnlBadge) {
                    totalPnlBadge.style.display = 'none';
                }
                
                // Update SPX price if available (without $ sign)
                if (data.spx_price && data.spx_price > 0) {
                    const spxPriceElements = document.querySelectorAll('.spx-price');
                    spxPriceElements.forEach(element => {
                        element.textContent = data.spx_price.toFixed(2);
                    });
                }
            }
        })
        .catch(error => {
            console.log('P&L refresh failed:', error);
        });
}

// Start auto-refresh immediately and always keep it running
function startAutoRefresh() {
    // Start auto-refresh every 5 seconds for real-time streaming data
    autoRefreshInterval = setInterval(updatePnLDisplay, 5000);
    updatePnLDisplay(); // Update immediately
}

// Start auto-refresh when page loads
startAutoRefresh();
</script>
{% endblock %}
